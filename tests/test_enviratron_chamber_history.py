import os
from datetime import datetime
from dateutil.tz import tzoffset
import sys
import pytest

sys.path.append(os.path.abspath(os.getcwd()))
from enviratron_chamber_history import EnviratronChamberHistoryParser


@pytest.fixture(scope="module")
def history():
    ''' Fixture providing a EnviratronChamberHistoryParser instance '''
    mongo_ip_address = os.getenv("ENVIRATRON_MONGODB_IP")
    history = EnviratronChamberHistoryParser(mongo_ip_address)
    return history


def test_smoke(history):
    """ Test that we can make a simple instance with a valid DB connection """
    assert history.db is not None, "Mongo DB connection NOT found"
    assert history.collection is not None, "Mongo DB collection not found"


def test_history_length_not_zero(history):
    """ Test that a call to get_chamber_history() method returns data """
    start_datetime = datetime(2019, 1, 1, 0, 0, 0, 0, tzinfo=tzoffset("UTC+0", 0))
    end_datetime = datetime(2019, 1, 1, 23, 59, 0, 0, tzinfo=tzoffset("UTC+0", 0))
    time_resolution = 30
    chamber_id = 5
    data = history.get_chamber_history(
        chamber_id, start_datetime, end_datetime, time_resolution
    )
    assert len(data) != 0, "data should NOT be zero-length"


def test_parsing_output(history, sample_chamberdata_record):

    parsed = history._parse_mongo_chamberdata_record(sample_chamberdata_record)

    assert parsed[0] == [
        "72e047c3d68d1f4ab7f83d97",
        "2019-01-01 10:30",
        23.0,
        22.899,
        60.0,
        59.0,
        50.0,
        54.0,
    ]


def test_parsing_default_resolution(history, sample_chamberdata_record):
    parsed = history._parse_mongo_chamberdata_record(sample_chamberdata_record)
    assert len(parsed) == 60, "There should be 60 timepoints in the parsed data"


def test_parsing_30_minute_resolution(history, sample_chamberdata_record):
    parsed_30_min_resolution = history._parse_mongo_chamberdata_record(
        sample_chamberdata_record, resolution_in_minutes=30
    )
    assert (
        len(parsed_30_min_resolution) == 2
    ), "There should be 2 timepoints in the parsed data"


def test_parsing_60_minute_resolution(history, sample_chamberdata_record):
    parsed = history._parse_mongo_chamberdata_record(
        sample_chamberdata_record, resolution_in_minutes=60
    )
    assert len(parsed) == 1, "There should one timepoint in the parsed data"


def test_parsing_with_end_datetime(history, sample_chamberdata_record):
    """ _parse_mongo_chamberdata_record() takes an optional end_datetime arg. Here we test various values for that arg"""
    end_datetime = datetime(2019, 1, 1, 10, 31, 0, tzinfo=tzoffset("UTC+0", 0))
    parsed = history._parse_mongo_chamberdata_record(
        sample_chamberdata_record, end_datetime=end_datetime
    )
    assert (
        len(parsed) == 2
    ), "The parsed data should have 2 timepoints for one-minute resolution and the specified end_datetime!"

    end_datetime = datetime(2019, 1, 1, 12, 0, 0, tzinfo=tzoffset("UTC+0", 0))
    parsed = history._parse_mongo_chamberdata_record(
        sample_chamberdata_record, end_datetime=end_datetime
    )
    assert (
        len(parsed) == 60
    ), "The parsed data should have 60 timepoints for one-minute resolution and the specified end_datetime!"

    # An out of range end datetime:
    end_datetime = datetime(2019, 1, 1, 1, 0, 0, tzinfo=tzoffset("UTC+0", 0))
    parsed = history._parse_mongo_chamberdata_record(
        sample_chamberdata_record, end_datetime=end_datetime
    )
    assert (
        len(parsed) == 0
    ), "The parsed data should have zero timepoints for one-minute resolution and the specified end_datetime!"


@pytest.fixture(scope="module")
def sample_chamberdata_record():
    ''' Fixture providing an approximation of a chamberdata record from the Mongo DB: '''

    return {
        "_id": "72e047c3d68d1f4ab7f83d97",
        "Count": 60,
        "ChamberId": "b8f681590cc4ac44ba21e2d3",
        "ConfigId": "c6214fa0a976c248883f16be",
        "Timestamp": "2019-01-01 10:30:00",
        "Inputs": {
            "PV_1": {
                "Values": [
                    22899,
                    22899,
                    23000,
                    23000,
                    22899,
                    22899,
                    23000,
                    23000,
                    22899,
                    23000,
                    23000,
                    23000,
                    23000,
                    22899,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23100,
                    23100,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    22799,
                    22200,
                    21700,
                    21600,
                    21700,
                    21899,
                    22000,
                    22000,
                    22000,
                    21899,
                    21899,
                    21899,
                    21899,
                    21899,
                    22000,
                    22000,
                    22000,
                    21899,
                    22000,
                    22000,
                    21899,
                    21899,
                    22000,
                    22000,
                    22000,
                ],
                "SetPoints": [
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    23000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                ],
            },
            "PV_2": {
                "Values": [
                    59000,
                    59000,
                    61000,
                    61000,
                    59000,
                    59000,
                    61000,
                    61000,
                    59000,
                    59000,
                    61000,
                    61000,
                    59000,
                    59000,
                    61000,
                    61000,
                    59000,
                    59000,
                    60000,
                    61000,
                    59000,
                    59000,
                    60000,
                    60000,
                    59000,
                    60000,
                    60000,
                    61000,
                    60000,
                    59000,
                    60000,
                    61000,
                    59000,
                    59000,
                    61000,
                    61000,
                    61000,
                    62000,
                    62000,
                    60000,
                    59000,
                    61000,
                    62000,
                    60000,
                    59000,
                    61000,
                    61000,
                    59000,
                    59000,
                    61000,
                    62000,
                    59000,
                    59000,
                    61000,
                    61000,
                    59000,
                    59000,
                    61000,
                    61000,
                    59000,
                ],
                "SetPoints": [
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                    60000,
                ],
            },
            "PV_3": {
                "Values": [
                    504000,
                    502000,
                    502000,
                    502000,
                    502000,
                    502000,
                    502000,
                    500000,
                    499000,
                    499000,
                    500000,
                    500000,
                    501000,
                    499000,
                    499000,
                    500000,
                    501000,
                    502000,
                    502000,
                    502000,
                    501000,
                    498000,
                    498000,
                    499000,
                    499000,
                    501000,
                    501000,
                    500000,
                    501000,
                    499000,
                    499000,
                    499000,
                    500000,
                    501000,
                    503000,
                    500000,
                    499000,
                    499000,
                    496000,
                    499000,
                    502000,
                    502000,
                    501000,
                    501000,
                    506000,
                    503000,
                    503000,
                    501000,
                    503000,
                    501000,
                    501000,
                    504000,
                    505000,
                    501000,
                    501000,
                    501000,
                    503000,
                    506000,
                    505000,
                    503000,
                ],
                "SetPoints": [
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                    400000,
                ],
            },
            "PV_4": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                "SetPoints": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
            },
            "PV_5": {
                "Values": [
                    54000,
                    54000,
                    54000,
                    54000,
                    53000,
                    54000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    54000,
                    54000,
                    54000,
                    53000,
                    54000,
                    53000,
                    54000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    54000,
                    53000,
                    54000,
                    53000,
                    53000,
                    53000,
                    54000,
                    54000,
                    54000,
                    54000,
                    53000,
                    54000,
                    53000,
                    53000,
                    54000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    54000,
                    54000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                    53000,
                ],
                "SetPoints": [
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                    50000,
                ],
            },
            "PV_7": {
                "Values": [
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                    24000,
                ],
                "SetPoints": [
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                    22000,
                ],
            },
        },
        "Lights": {
            "EO_1": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_2": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_3": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_4": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_5": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_6": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_7": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_13": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_14": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
            "EO_15": {
                "Values": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ]
            },
        },
    }
